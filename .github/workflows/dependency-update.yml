name: Dependency Updates

on:
  schedule:
    # 每周一早上 8:00 UTC 运行
    - cron: '0 8 * * 1'
  workflow_dispatch: # 允许手动触发

jobs:
  update-python-dependencies:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
    
    - name: Update Python dependencies
      working-directory: hello-edge-tts-python
      run: |
        # 检查是否存在 requirements.in 文件，如果没有则从 requirements.txt 创建
        if [ ! -f requirements.in ]; then
          cp requirements.txt requirements.in
        fi
        
        # 更新依赖
        pip-compile --upgrade requirements.in
        
        # 检查是否有变化
        if git diff --quiet requirements.txt; then
          echo "No dependency updates available"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        fi
    
    - name: Create Pull Request for Python
      if: env.HAS_CHANGES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(python): update dependencies"
        title: "🔄 Update Python dependencies"
        body: |
          ## Python Dependencies Update
          
          This PR updates Python dependencies to their latest versions.
          
          ### Changes
          - Updated `requirements.txt` with latest compatible versions
          
          ### Testing
          - [ ] All tests pass
          - [ ] No breaking changes detected
          
          Auto-generated by GitHub Actions 🤖
        branch: update-python-dependencies
        delete-branch: true
        labels: |
          dependencies
          python
          automated

  update-dart-dependencies:
    name: Update Dart Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Dart
      uses: dart-lang/setup-dart@v1
      with:
        dart-version: 'stable'
    
    - name: Update Dart dependencies
      working-directory: hello-edge-tts-dart
      run: |
        # 更新依赖
        dart pub upgrade
        
        # 检查是否有变化
        if git diff --quiet pubspec.lock; then
          echo "No dependency updates available"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        fi
    
    - name: Create Pull Request for Dart
      if: env.HAS_CHANGES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(dart): update dependencies"
        title: "🔄 Update Dart dependencies"
        body: |
          ## Dart Dependencies Update
          
          This PR updates Dart dependencies to their latest versions.
          
          ### Changes
          - Updated `pubspec.lock` with latest compatible versions
          
          ### Testing
          - [ ] All tests pass
          - [ ] No breaking changes detected
          
          Auto-generated by GitHub Actions 🤖
        branch: update-dart-dependencies
        delete-branch: true
        labels: |
          dependencies
          dart
          automated

  update-rust-dependencies:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: Install cargo-edit
      run: cargo install cargo-edit
    
    - name: Update Rust dependencies
      working-directory: hello-edge-tts-rust
      run: |
        # 更新依赖
        cargo upgrade
        cargo update
        
        # 检查是否有变化
        if git diff --quiet Cargo.toml Cargo.lock; then
          echo "No dependency updates available"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        fi
    
    - name: Create Pull Request for Rust
      if: env.HAS_CHANGES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(rust): update dependencies"
        title: "🔄 Update Rust dependencies"
        body: |
          ## Rust Dependencies Update
          
          This PR updates Rust dependencies to their latest versions.
          
          ### Changes
          - Updated `Cargo.toml` and `Cargo.lock` with latest compatible versions
          
          ### Testing
          - [ ] All tests pass
          - [ ] No breaking changes detected
          
          Auto-generated by GitHub Actions 🤖
        branch: update-rust-dependencies
        delete-branch: true
        labels: |
          dependencies
          rust
          automated

  update-java-dependencies:
    name: Update Java Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Update Java dependencies
      working-directory: hello-edge-tts-java
      run: |
        # 使用 Maven versions plugin 更新依赖
        mvn versions:use-latest-releases
        mvn versions:update-properties
        
        # 检查是否有变化
        if git diff --quiet pom.xml; then
          echo "No dependency updates available"
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
        else
          echo "Dependencies updated"
          echo "HAS_CHANGES=true" >> $GITHUB_ENV
        fi
    
    - name: Create Pull Request for Java
      if: env.HAS_CHANGES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore(java): update dependencies"
        title: "🔄 Update Java dependencies"
        body: |
          ## Java Dependencies Update
          
          This PR updates Java dependencies to their latest versions.
          
          ### Changes
          - Updated `pom.xml` with latest compatible versions
          
          ### Testing
          - [ ] All tests pass
          - [ ] No breaking changes detected
          
          Auto-generated by GitHub Actions 🤖
        branch: update-java-dependencies
        delete-branch: true
        labels: |
          dependencies
          java
          automated

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Python Security Audit
      working-directory: hello-edge-tts-python
      run: |
        python -m pip install --upgrade pip
        pip install safety
        safety check -r requirements.txt || true
    
    - name: Rust Security Audit
      working-directory: hello-edge-tts-rust
      run: |
        cargo install cargo-audit
        cargo audit || true
    
    - name: Java Security Audit
      working-directory: hello-edge-tts-java
      run: |
        mvn org.owasp:dependency-check-maven:check || true
    
    - name: Create Security Issue
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: '🚨 Security vulnerabilities detected',
            body: 'Security audit found vulnerabilities in dependencies. Please review and update.',
            labels: ['security', 'high-priority']
          })